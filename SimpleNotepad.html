<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secure Notepad Pro - Encrypted Notes</title>
    <meta name="description" content="A secure notepad with client-side encryption to protect your notes">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0b1220;
            --sidebar-bg: #070b15;
            --card: #0f172a;
            --muted: #94a3b8;
            --text: #e2e8f0;
            --accent: #38bdf8;
            --accent-2: #22c55e;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --border: rgba(148, 163, 184, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
            background: radial-gradient(1200px 800px at 10% -10%, #0b2a3a 0%, transparent 60%),
                radial-gradient(1200px 800px at 110% 10%, #1a1f61 0%, transparent 60%),
                var(--bg);
            color: var(--text);
            line-height: 1.5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            overflow-y: auto;
        }

        .logo-area {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 5px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            color: var(--accent);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 13px;
            color: var(--muted);
            margin-left: 44px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            padding: 0 20px;
            margin-bottom: 15px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        .nav-btn i {
            width: 20px;
            font-size: 16px;
        }

        .nav-btn.active {
            background: rgba(56, 189, 248, 0.15);
            border-right: 3px solid var(--accent);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(15, 23, 42, 0.5);
            margin-left: auto;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.3);
        }

        .note-title {
            font-size: 18px;
            font-weight: 600;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
        }

        .editor-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
            min-height: 300px;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .encrypted-content {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            word-break: break-all;
            white-space: pre-wrap;
            opacity: 0.8;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .editor-tools {
            display: flex;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.3);
        }

        .btn {
            appearance: none;
            border: 1px solid transparent;
            background: var(--accent);
            color: #082032;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: .15s transform, .2s filter;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn i {
            font-size: 14px;
        }

        .btn-secondary {
            background: #1f2a44;
            color: var(--text);
            border-color: var(--border);
        }

        .btn-success {
            background: var(--accent-2);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            color: var(--muted);
            font-size: 12px;
            border-top: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.3);
        }

        /* Formatting toolbar */
        .formatting-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .format-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .format-btn:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
        }

        .format-btn.active {
            background: rgba(56, 189, 248, 0.2);
            color: var(--accent);
        }

        /* Note list */
        .note-list {
            padding: 10px 0;
        }

        .note-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .note-item:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        .note-item:hover .note-item-delete {
            opacity: 1;
        }

        .note-item.active {
            background: rgba(56, 189, 248, 0.15);
        }

        .note-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 0;
        }

        .note-item-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            margin-right: 10px;
        }

        .note-item-name {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-item-date {
            font-size: 11px;
            color: var(--muted);
        }

        .note-item-encrypted {
            color: var(--accent);
            margin-left: 8px;
            font-size: 12px;
        }

        .note-item-delete {
            color: var(--muted);
            padding: 5px;
            margin-left: 8px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
        }

        .note-item-delete:hover {
            color: var(--danger);
        }

        /* Search box */
        .search-box {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            background: #0b132b;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        /* Themes panel */
        .themes-panel {
            padding: 15px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
        }

        .theme-option:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        .theme-option.active {
            background: rgba(56, 189, 248, 0.15);
            border-color: var(--accent);
        }

        .theme-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .theme-name {
            flex: 1;
            font-size: 14px;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(11, 18, 32, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .5);
        }

        .modal-title {
            margin-bottom: 16px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-body {
            margin-bottom: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
            position: relative;
        }

        label {
            display: block;
            margin: 2px 0 6px;
            color: #cbd5e1;
            font-size: 13px;
        }

        input[type="password"],
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            background: #0b132b;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 15px;
            outline: none;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: var(--muted);
        }

        .toggle-password:hover {
            color: var(--text);
        }

        .param-info {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Utilities */
        .hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }

        .loader {
            display: none;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading {
            display: inline-flex;
            align-items: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }

        /* Password strength meter */
        .strength-meter {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .strength-meter-fill {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s, background 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 15px;
            }

            .nav-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .nav-btn {
                width: auto;
                border-radius: 8px;
            }

            .nav-btn.active {
                border-right: none;
                border-bottom: 3px solid var(--accent);
            }

            .note-item-delete {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-area">
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M8 7V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 7V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 7V11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span class="logo-text">Secure Notepad Pro</span>
            </div>
            <p class="subtitle">Your private encrypted notes</p>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" id="searchNotes" placeholder="Search notes...">
        </div>

        <div class="nav-section">
            <h3 class="section-title">Notes</h3>
            <div class="note-list" id="noteList">
                <!-- Notes will be populated here -->
            </div>
        </div>

        <div class="nav-section">
            <h3 class="section-title">Actions</h3>
            <div class="nav-buttons">
                <button class="nav-btn active" id="btnNewNote">
                    <i class="fas fa-plus"></i> New Note
                </button>
                <button class="nav-btn" id="btnSaveNote">
                    <i class="fas fa-save"></i> Save Note
                </button>
                <button class="nav-btn" id="btnLoadNote">
                    <i class="fas fa-folder-open"></i> Load Note
                </button>
                <button class="nav-btn" id="btnExportNote">
                    <i class="fas fa-file-export"></i> Export Note
                </button>
            </div>
        </div>

        <div class="nav-section">
            <h3 class="section-title">Security</h3>
            <div class="nav-buttons">
                <button class="nav-btn" id="btnEncryptNote">
                    <i class="fas fa-lock"></i> Encrypt Note
                </button>
                <button class="nav-btn" id="btnDecryptNote" disabled>
                    <i class="fas fa-unlock"></i> Decrypt Note
                    <span class="status-badge" id="encryptionStatus">🔓</span>
                </button>
                <button class="nav-btn" id="btnPasswordGenerator">
                    <i class="fas fa-key"></i> Password Generator
                </button>
            </div>
        </div>

        <div class="nav-section">
            <h3 class="section-title">Tools</h3>
            <div class="nav-buttons">
                <button class="nav-btn" id="btnCopy">
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
                <button class="nav-btn" id="btnClear">
                    <i class="fas fa-broom"></i> Clear Note
                </button>
                <button class="nav-btn" id="btnWordCount">
                    <i class="fas fa-font"></i> Word Count
                </button>
                <button class="nav-btn" id="btnSettings">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <div class="note-title" id="noteTitle" contenteditable="true">Untitled Note</div>
            <div class="quick-actions">
                <button class="action-btn" id="btnQuickSave" title="Save (Ctrl+S)">
                    <i class="fas fa-save"></i>
                </button>
                <button class="action-btn" id="btnQuickEncrypt" title="Encrypt (Ctrl+E)">
                    <i class="fas fa-lock"></i>
                </button>
                <button class="action-btn" id="btnQuickDecrypt" title="Decrypt (Ctrl+D)" disabled>
                    <i class="fas fa-unlock"></i>
                </button>
                <button class="action-btn" id="btnPrint" title="Print Note">
                    <i class="fas fa-print"></i>
                </button>
                <button class="action-btn" id="btnFullscreen" title="Toggle Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>

        <div class="formatting-toolbar">
            <button class="format-btn" id="btnBold" title="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
            <button class="format-btn" id="btnItalic" title="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
            <button class="format-btn" id="btnUnderline" title="Underline (Ctrl+U)"><i class="fas fa-underline"></i></button>
            <button class="format-btn" id="btnListUl" title="Bullet List"><i class="fas fa-list-ul"></i></button>
            <button class="format-btn" id="btnListOl" title="Numbered List"><i class="fas fa-list-ol"></i></button>
            <button class="format-btn" id="btnLink" title="Insert Link"><i class="fas fa-link"></i></button>
            <button class="format-btn" id="btnCode" title="Code Block"><i class="fas fa-code"></i></button>
            <button class="format-btn" id="btnQuote" title="Blockquote"><i class="fas fa-quote-right"></i></button>
        </div>

        <div class="editor-container">
            <textarea id="editor" placeholder="Start typing your note here..."></textarea>
            <div id="encryptedContent" class="encrypted-content" style="display: none;"></div>
        </div>

        <div class="status-bar">
            <div class="status" id="status">Ready. Notes are saved directly to your device.</div>
            <div class="document-info">
                <span id="charCount">0 characters</span> • <span id="wordCount">0 words</span> • <span id="lineCount">0 lines</span>
            </div>
        </div>
    </div>

    <!-- Hidden file input for loading notes -->
    <input type="file" id="fileInput" accept=".txt,.json" style="display: none;" />

    <!-- Encryption Modal -->
    <div class="modal" id="encryptModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-lock"></i> Encrypt Note</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label for="encryptPassword">Password</label>
                    <div class="password-wrapper">
                        <input id="encryptPassword" type="password" placeholder="Enter a strong password" />
                        <button class="toggle-password" type="button" aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="encryptHint">Password Hint (optional)</label>
                    <input id="encryptHint" type="text" placeholder="e.g. My pet's name" />
                </div>

                <div class="form-group">
                    <label for="encryptArgonPreset">Encryption Strength</label>
                    <select id="encryptArgonPreset">
                        <option value="interactive">Interactive (faster)</option>
                        <option value="moderate" selected>Moderate (balanced)</option>
                        <option value="sensitive">Sensitive (stronger)</option>
                    </select>
                    <div class="param-info" id="encryptParamInfo">Time: 3, Memory: 512MB, Parallelism: 1</div>
                </div>

                <div class="hint">This password will be required to decrypt the note. Make sure you remember it!</div>
            </div>
            <div class="modal-actions">
                <button id="btnCancelEncrypt" class="btn btn-secondary">Cancel</button>
                <button id="btnConfirmEncrypt" class="btn btn-success">Encrypt</button>
            </div>
        </div>
    </div>

    <!-- Decryption Modal -->
    <div class="modal" id="decryptModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-unlock"></i> Decrypt Note</h3>
            <div class="modal-body">
                <div id="passwordHint" class="hint" style="display: none; margin-bottom: 15px;"></div>

                <div class="form-group">
                    <label for="decryptPassword">Password</label>
                    <div class="password-wrapper">
                        <input id="decryptPassword" type="password" placeholder="Enter the note's password" autocomplete="current-password" />
                        <button class="toggle-password" type="button" aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="decryptArgonPreset">Encryption Strength (if known)</label>
                    <select id="decryptArgonPreset">
                        <option value="interactive">Interactive (faster)</option>
                        <option value="moderate" selected>Moderate (balanced)</option>
                        <option value="sensitive">Sensitive (stronger)</option>
                    </select>
                    <div class="param-info" id="decryptParamInfo">Time: 3, Memory: 512MB, Parallelism: 1</div>
                </div>

                <div class="hint">Enter the password used to encrypt this note.</div>
            </div>
            <div class="modal-actions">
                <button id="btnCancelDecrypt" class="btn btn-secondary">Cancel</button>
                <button id="btnConfirmDecrypt" class="btn btn-success">Decrypt</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-cog"></i> Settings</h3>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="security">Security</div>
                    <div class="tab" data-tab="appearance">Appearance</div>
                </div>

                <div id="generalTab" class="tab-content">
                    <div class="form-group">
                        <label for="autoSave">Auto-save</label>
                        <select id="autoSave">
                            <option value="off">Off</option>
                            <option value="1">Every minute</option>
                            <option value="5" selected>Every 5 minutes</option>
                            <option value="10">Every 10 minutes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="spellCheck">Spell Check</label>
                        <select id="spellCheck">
                            <option value="off">Off</option>
                            <option value="on" selected>On</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="defaultEncryption">Default Encryption Strength</label>
                        <select id="defaultEncryption">
                            <option value="interactive">Interactive (faster)</option>
                            <option value="moderate" selected>Moderate (balanced)</option>
                            <option value="sensitive">Sensitive (stronger)</option>
                        </select>
                    </div>
                </div>

                <div id="securityTab" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <label for="clearClipboard">Clear Clipboard After</label>
                        <select id="clearClipboard">
                            <option value="0">Never</option>
                            <option value="10">10 seconds</option>
                            <option value="30" selected>30 seconds</option>
                            <option value="60">1 minute</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sessionTimeout">Session Timeout</label>
                        <select id="sessionTimeout">
                            <option value="0">Never</option>
                            <option value="5">5 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>
                </div>

                <div id="appearanceTab" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <label for="theme">Theme</label>
                        <select id="theme">
                            <option value="dark" selected>Dark</option>
                            <option value="light">Light</option>
                            <option value="system">System Default</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fontSize">Font Size</label>
                        <select id="fontSize">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                            <option value="x-large">X-Large</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fontFamily">Font Family</label>
                        <select id="fontFamily">
                            <option value="inter" selected>Inter</option>
                            <option value="system">System UI</option>
                            <option value="monospace">Monospace</option>
                            <option value="serif">Serif</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCancelSettings" class="btn btn-secondary">Cancel</button>
                <button id="btnSaveSettings" class="btn btn-success">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Password Generator Modal -->
    <div class="modal" id="passwordGeneratorModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-key"></i> Password Generator</h3>
            <div class="modal-body">
                <div class="hint">Generate strong passwords for your encrypted notes.</div>

                <div class="form-group">
                    <label for="passwordLength">Password Length</label>
                    <input id="passwordLength" type="number" min="8" max="50" value="16" />
                </div>

                <div class="form-group">
                    <label>Character Sets</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="includeUppercase" checked />
                            Include Uppercase Letters (A-Z)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="includeLowercase" checked />
                            Include Lowercase Letters (a-z)
                        </label>
                        <label style="display: flex; align-items; center; gap: 8px;">
                            <input type="checkbox" id="includeNumbers" checked />
                            Include Numbers (0-9)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="includeSymbols" checked />
                            Include Symbols (!@#$%^&* etc.)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="generatedPassword">Generated Password</label>
                    <div class="password-wrapper">
                        <input id="generatedPassword" type="text" readonly />
                        <button class="toggle-password" type="button" aria-label="Show password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>

                    <div id="passwordStrength" style="margin-top: 8px; font-size: 12px;">
                        Strength: <span id="strengthValue">-</span>
                        <div class="strength-meter">
                            <div id="strengthMeter" class="strength-meter-fill"></div>
                        </div>
                    </div>
                </div>

                <button id="generatePasswordBtn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-sync-alt"></i> Generate New Password
                </button>
            </div>
            <div class="modal-actions">
                <button id="btnCancelPasswordGenerator" class="btn btn-secondary">Close</button>
                <button id="usePasswordInEncryptBtn" class="btn btn-success">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Word Count Modal -->
    <div class="modal" id="wordCountModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-font"></i> Document Statistics</h3>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h4>Counts</h4>
                        <p>Words: <span id="statWords">0</span></p>
                        <p>Characters: <span id="statChars">0</span></p>
                        <p>Characters (no spaces): <span id="statCharsNoSpaces">0</span></p>
                        <p>Lines: <span id="statLines">0</span></p>
                    </div>
                    <div>
                        <h4>Reading</h4>
                        <p>Reading time: <span id="statReadingTime">0</span> min</p>
                        <p>Speaking time: <span id="statSpeakingTime">0</span> min</p>
                        <p>Sentences: <span id="statSentences">0</span></p>
                        <p>Paragraphs: <span id="statParagraphs">0</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btnCloseWordCount" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-trash"></i> Delete Note</h3>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteNoteName"></span>"?</p>
                <p class="hint">This action cannot be undone.</p>
            </div>
            <div class="modal-actions">
                <button id="btnCancelDelete" class="btn btn-secondary">Cancel</button>
                <button id="btnConfirmDelete" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Load argon2-browser (bundled; exposes window.argon2) -->
    <script src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"></script>

    <script>
        (async () => {
            // DOM Elements
            const qs = (s) => document.querySelector(s);
            const editor = qs('#editor');
            const encryptedContent = qs('#encryptedContent');
            const statusEl = qs('#status');
            const encryptionStatus = qs('#encryptionStatus');
            const noteTitle = qs('#noteTitle');
            const charCount = qs('#charCount');
            const wordCount = qs('#wordCount');
            const lineCount = qs('#lineCount');
            const noteList = qs('#noteList');
            const searchInput = qs('#searchNotes');

            // Buttons
            const btnNewNote = qs('#btnNewNote');
            const btnSaveNote = qs('#btnSaveNote');
            const btnEncryptNote = qs('#btnEncryptNote');
            const btnDecryptNote = qs('#btnDecryptNote');
            const btnPasswordGenerator = qs('#btnPasswordGenerator');
            const btnLoadNote = qs('#btnLoadNote');
            const btnExportNote = qs('#btnExportNote');
            const btnCopy = qs('#btnCopy');
            const btnClear = qs('#btnClear');
            const btnWordCount = qs('#btnWordCount');
            const btnSettings = qs('#btnSettings');

            // Quick action buttons
            const btnQuickSave = qs('#btnQuickSave');
            const btnQuickEncrypt = qs('#btnQuickEncrypt');
            const btnQuickDecrypt = qs('#btnQuickDecrypt');
            const btnPrint = qs('#btnPrint');
            const btnFullscreen = qs('#btnFullscreen');

            // Formatting buttons
            const btnBold = qs('#btnBold');
            const btnItalic = qs('#btnItalic');
            const btnUnderline = qs('#btnUnderline');
            const btnListUl = qs('#btnListUl');
            const btnListOl = qs('#btnListOl');
            const btnLink = qs('#btnLink');
            const btnCode = qs('#btnCode');
            const btnQuote = qs('#btnQuote');

            // File input
            const fileInput = qs('#fileInput');

            // Modals
            const encryptModal = qs('#encryptModal');
            const decryptModal = qs('#decryptModal');
            const settingsModal = qs('#settingsModal');
            const passwordGeneratorModal = qs('#passwordGeneratorModal');
            const wordCountModal = qs('#wordCountModal');
            const deleteConfirmModal = qs('#deleteConfirmModal');

            const btnConfirmEncrypt = qs('#btnConfirmEncrypt');
            const btnCancelEncrypt = qs('#btnCancelEncrypt');
            const btnConfirmDecrypt = qs('#btnConfirmDecrypt');
            const btnCancelDecrypt = qs('#btnCancelDecrypt');
            const btnSaveSettings = qs('#btnSaveSettings');
            const btnCancelSettings = qs('#btnCancelSettings');
            const btnCancelPasswordGenerator = qs('#btnCancelPasswordGenerator');
            const btnCloseWordCount = qs('#btnCloseWordCount');
            const btnConfirmDelete = qs('#btnConfirmDelete');
            const btnCancelDelete = qs('#btnCancelDelete');

            // Password Generator Elements
            const generatePasswordBtn = qs('#generatePasswordBtn');
            const usePasswordInEncryptBtn = qs('#usePasswordInEncryptBtn');
            const generatedPasswordInput = qs('#generatedPassword');

            // State
            let currentNote = {
                id: generateId(),
                content: '',
                isEncrypted: false,
                encryptionParams: null,
                fileHandle: null,
                title: 'Untitled Note',
                createdAt: Date.now(),
                updatedAt: Date.now(),
                passwordHint: ''
            };

            let notes = [];
            let settings = {
                autoSave: '5',
                spellCheck: 'on',
                defaultEncryption: 'moderate',
                clearClipboard: '30',
                sessionTimeout: '30',
                theme: 'dark',
                fontSize: 'medium',
                fontFamily: 'inter'
            };

            let isFullscreen = false;
            let autoSaveInterval = null;
            let noteToDelete = null;

            // Argon2 parameters
            const argonParams = {
                interactive: {
                    time: 2,
                    mem: 65536,
                    parallelism: 1,
                    desc: "Time: 2, Memory: 64MB, Parallelism: 1"
                },
                moderate: {
                    time: 3,
                    mem: 524288,
                    parallelism: 1,
                    desc: "Time: 3, Memory: 512MB, Parallelism: 1"
                },
                sensitive: {
                    time: 5,
                    mem: 1048576,
                    parallelism: 1,
                    desc: "Time: 5, Memory: 1GB, Parallelism: 1"
                }
            };

            // Initialize
            init();

            async function init() {
                // Load settings and notes
                loadSettings();
                loadNotes();

                // Set up event listeners
                setupEventListeners();

                // Check for secure context
                if (!window.isSecureContext) {
                    setStatus('Warning: This page must be served over HTTPS or http://localhost for Web Crypto to work securely.', false);
                }

                // Wait for Argon2 WASM to be ready (optional)
                try {
                    if (window.argon2 && argon2.ready) {
                        await argon2.ready;
                    }
                } catch (e) {
                    setStatus('Argon2 failed to initialize. Encryption features may not work.', false);
                    console.error(e);
                }

                // Apply settings
                applySettings();

                // Update UI
                updateEditorState();
                updateParamInfo();
                updateCounts();

                // Setup auto-save
                setupAutoSave();
            }

            function setupEventListeners() {
                // Editor events
                editor.addEventListener('input', () => {
                    const value = editor.value;
                    currentNote.content = value;
                    currentNote.updatedAt = Date.now();

                    if (isLikelyEncrypted(value)) {
                        // If it looks encrypted, treat as encrypted
                        currentNote.isEncrypted = true;

                        // Hide editor, show encrypted block
                        editor.style.display = 'none';
                        encryptedContent.style.display = 'block';
                        encryptedContent.textContent = value;
                    } else {
                        // Otherwise treat as plaintext
                        currentNote.isEncrypted = false;

                        // Show editor, hide encrypted block
                        editor.style.display = 'block';
                        encryptedContent.style.display = 'none';
                    }

                    saveCurrentNote();
                    updateCounts();
                    updateEditorState();
                });

                // Title editing
                noteTitle.addEventListener('blur', () => {
                    const newTitle = noteTitle.textContent.trim() || 'Untitled Note';
                    currentNote.title = newTitle;
                    currentNote.updatedAt = Date.now();
                    saveCurrentNote();
                    renderNoteList();
                    setStatus('Title updated.');
                });

                // Search input
                searchInput.addEventListener('input', renderNoteList);

                // Sidebar navigation buttons
                btnNewNote.addEventListener('click', createNewNote);
                btnSaveNote.addEventListener('click', saveNoteToFile);
                btnEncryptNote.addEventListener('click', showEncryptModal);
                btnDecryptNote.addEventListener('click', showDecryptModal);
                btnPasswordGenerator.addEventListener('click', showPasswordGenerator);
                btnLoadNote.addEventListener('click', loadNoteFromFile);
                btnExportNote.addEventListener('click', exportNote);
                btnCopy.addEventListener('click', copyToClipboard);
                btnClear.addEventListener('click', clearNote);
                btnWordCount.addEventListener('click', showWordCountStats);
                btnSettings.addEventListener('click', showSettingsModal);

                // Quick action buttons
                btnQuickSave.addEventListener('click', saveNoteToFile);
                btnQuickEncrypt.addEventListener('click', showEncryptModal);
                btnQuickDecrypt.addEventListener('click', showDecryptModal);
                btnPrint.addEventListener('click', printNote);
                btnFullscreen.addEventListener('click', toggleFullscreen);

                // Formatting buttons
                btnBold.addEventListener('click', () => applyTextFormatting('bold'));
                btnItalic.addEventListener('click', () => applyTextFormatting('italic'));
                btnUnderline.addEventListener('click', () => applyTextFormatting('underline'));
                btnListUl.addEventListener('click', () => applyTextFormatting('insertUnorderedList'));
                btnListOl.addEventListener('click', () => applyTextFormatting('insertOrderedList'));
                btnLink.addEventListener('click', () => {
                    const url = prompt('Enter URL:', 'https://');
                    if (url) applyTextFormatting('createLink', url);
                });
                btnCode.addEventListener('click', () => {
                    applyTextFormatting('formatBlock', '<pre>');
                });
                btnQuote.addEventListener('click', () => {
                    applyTextFormatting('formatBlock', '<blockquote>');
                });

                // Modal buttons
                btnConfirmEncrypt.addEventListener('click', doEncrypt);
                btnCancelEncrypt.addEventListener('click', hideEncryptModal);
                btnConfirmDecrypt.addEventListener('click', doDecrypt);
                btnCancelDecrypt.addEventListener('click', hideDecryptModal);
                btnSaveSettings.addEventListener('click', saveSettingsFromModal);
                btnCancelSettings.addEventListener('click', hideSettingsModal);
                btnCancelPasswordGenerator.addEventListener('click', hidePasswordGenerator);
                btnCloseWordCount.addEventListener('click', () => {
                    hideModal(wordCountModal);
                });
                btnConfirmDelete.addEventListener('click', deleteNote);
                btnCancelDelete.addEventListener('click', hideDeleteConfirm);

                // Password generator buttons
                generatePasswordBtn.addEventListener('click', generateNewPassword);
                usePasswordInEncryptBtn.addEventListener('click', copyGeneratedPassword);
                
                // Toggle password visibility in password generator
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const input = this.parentElement.querySelector('input');
                        const type = input.type === 'password' ? 'text' : 'password';
                        input.type = type;
                        this.querySelector('i').className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
                    });
                });

                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        tab.classList.add('active');

                        // Show corresponding tab content
                        const tabName = tab.getAttribute('data-tab');
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.style.display = 'none';
                        });
                        qs(`#${tabName}Tab`).style.display = 'block';
                    });
                });

                // Argon2 preset selectors
                qs('#encryptArgonPreset').addEventListener('change', updateParamInfo);
                qs('#decryptArgonPreset').addEventListener('change', updateParamInfo);

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 's':
                                e.preventDefault();
                                saveNoteToFile();
                                break;
                            case 'e':
                                e.preventDefault();
                                if (!currentNote.isEncrypted) {
                                    showEncryptModal();
                                }
                                break;
                            case 'd':
                                e.preventDefault();
                                if (currentNote.isEncrypted) {
                                    showDecryptModal();
                                }
                                break;
                            case 'n':
                                e.preventDefault();
                                createNewNote();
                                break;
                            case 'b':
                                e.preventDefault();
                                applyTextFormatting('bold');
                                break;
                            case 'i':
                                e.preventDefault();
                                applyTextFormatting('italic');
                                break;
                            case 'u':
                                e.preventDefault();
                                applyTextFormatting('underline');
                                break;
                        }
                    }
                    
                    // Escape key to close modals
                    if (e.key === 'Escape') {
                        const activeModals = document.querySelectorAll('.modal.active');
                        if (activeModals.length > 0) {
                            activeModals.forEach(modal => {
                                hideModal(modal);
                            });
                        }
                    }
                });

                // Click outside modals to close
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        hideModal(e.target);
                    }
                });

                // Handle fullscreen change events
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement && isFullscreen) {
                        isFullscreen = false;
                        btnFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
                        btnFullscreen.title = 'Toggle Fullscreen';
                    }
                });
            }

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            function setStatus(msg, isWorking = false) {
                if (isWorking) {
                    statusEl.innerHTML = '<span class="loading"><span class="loader"></span>' + msg + '</span>';
                } else {
                    statusEl.textContent = msg;
                }
                
                // Persist status message in localStorage for session continuity
                try {
                    localStorage.setItem('lastStatusMessage', msg);
                } catch (e) {
                    console.error('Error saving status message:', e);
                }
            }

            function loadSettings() {
                const savedSettings = localStorage.getItem('notepadSettings');
                if (savedSettings) {
                    try {
                        settings = {
                            ...settings,
                            ...JSON.parse(savedSettings)
                        };
                    } catch (e) {
                        console.error('Error loading settings:', e);
                    }
                }
                
                // Load last status message if available
                const lastStatus = localStorage.getItem('lastStatusMessage');
                if (lastStatus) {
                    setStatus(lastStatus);
                }
            }

            function saveSettings() {
                try {
                    localStorage.setItem('notepadSettings', JSON.stringify(settings));
                    return true;
                } catch (e) {
                    console.error('Error saving settings:', e);
                    setStatus('Error saving settings: ' + e.message);
                    return false;
                }
            }

            function applySettings() {
                // Apply theme
                document.body.setAttribute('data-theme', settings.theme);

                // Apply font size
                document.documentElement.style.setProperty('--editor-font-size',
                    settings.fontSize === 'small' ? '14px' :
                    settings.fontSize === 'medium' ? '15px' :
                    settings.fontSize === 'large' ? '16px' : '18px');

                // Apply font family
                const fontMap = {
                    'inter': "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif",
                    'system': "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif",
                    'monospace': "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
                    'serif': "Georgia, serif"
                };
                document.documentElement.style.setProperty('--editor-font-family', fontMap[settings.fontFamily]);

                // Apply spell check
                editor.spellcheck = settings.spellCheck === 'on';
            }

            function loadNotes() {
                try {
                    const savedNotes = localStorage.getItem('notepadNotes');
                    notes = savedNotes ? JSON.parse(savedNotes) : [];
                } catch (e) {
                    console.error('Error loading notes:', e);
                    notes = [];
                }

                renderNoteList();

                // 🔥 Always sync currentNote after load
                if (notes.length > 0) {
                    currentNote = { ...notes[0] }; // copy first note
                } else {
                    currentNote = null; // stay empty until user creates one
                }
            }

            function saveNotes() {
                try {
                    localStorage.setItem('notepadNotes', JSON.stringify(notes));
                } catch (e) {
                    console.error('Error saving notes:', e);
                    setStatus('Error saving notes: ' + e.message);
                }
            }

            function renderNoteList() {
                noteList.innerHTML = '';

                const searchTerm = searchInput.value.toLowerCase();
                const filteredNotes = notes.filter(note =>
                    note.title.toLowerCase().includes(searchTerm) ||
                    (note.passwordHint && note.passwordHint.toLowerCase().includes(searchTerm))
                );

                if (filteredNotes.length === 0) {
                    noteList.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--muted);">No notes found</div>';
                    return;
                }

                filteredNotes.forEach(note => {
                    const noteEl = document.createElement('div');
                    noteEl.className = `note-item ${note.id === currentNote.id ? 'active' : ''}`;
                    noteEl.setAttribute('data-id', note.id);
                    noteEl.innerHTML = `
                        <div class="note-item-content">
                            <div class="note-item-info">
                                <div class="note-item-name">${note.title}</div>
                                <div class="note-item-date">${formatDate(note.updatedAt)}</div>
                            </div>
                            ${note.isEncrypted ? '<div class="note-item-encrypted"><i class="fas fa-lock"></i></div>' : ''}
                            <div class="note-item-delete" data-id="${note.id}">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    `;
                    
                    noteEl.addEventListener('click', (e) => {
                        // Don't trigger note loading if clicking the delete button
                        if (!e.target.closest('.note-item-delete')) {
                            loadNoteById(note.id);
                        }
                    });

                    // Add delete button event listener
                    const deleteBtn = noteEl.querySelector('.note-item-delete');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showDeleteConfirm(note);
                    });

                    noteList.appendChild(noteEl);
                });
            }

            function formatDate(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return 'Today';
                } else if (diffDays === 1) {
                    return 'Yesterday';
                } else if (diffDays < 7) {
                    return `${diffDays} days ago`;
                } else {
                    return date.toLocaleDateString();
                }
            }

            function updateCounts() {
                const text = currentNote.isEncrypted ? currentNote.content : editor.value;
                const charCountValue = text.length;
                const wordCountValue = text.trim() ? text.trim().split(/\s+/).length : 0;
                const lineCountValue = text.split('\n').length;

                charCount.textContent = `${charCountValue} characters`;
                wordCount.textContent = `${wordCountValue} words`;
                lineCount.textContent = `${lineCountValue} lines`;
            }

            function calculateWordCountStats(text) {
                // Remove extra whitespace and split into words
                const words = text.trim() ? text.trim().split(/\s+/) : [];
                const wordCount = words.length;

                // Character counts
                const charCount = text.length;
                const charCountNoSpaces = text.replace(/\s+/g, '').length;

                // Line count
                const lineCount = text.split('\n').length;

                // Sentence count (approximate)
                const sentenceCount = text.split(/[.!?]+/).filter(s => s.length > 0).length;

                // Paragraph count
                const paragraphCount = text.split(/\n\s*\n/).filter(p => p.length > 0).length;

                // Reading time (assuming 225 words per minute)
                const readingTime = Math.ceil(wordCount / 225);

                // Speaking time (assuming 150 words per minute)
                const speakingTime = Math.ceil(wordCount / 150);

                return {
                    words: wordCount,
                    characters: charCount,
                    charactersNoSpaces: charCountNoSpaces,
                    lines: lineCount,
                    sentences: sentenceCount,
                    paragraphs: paragraphCount,
                    readingTime: readingTime,
                    speakingTime: speakingTime
                };
            }

            function showWordCountStats() {
                const text = currentNote.isEncrypted ? currentNote.content : editor.value;
                const stats = calculateWordCountStats(text);

                document.getElementById('statWords').textContent = stats.words;
                document.getElementById('statChars').textContent = stats.characters;
                document.getElementById('statCharsNoSpaces').textContent = stats.charactersNoSpaces;
                document.getElementById('statLines').textContent = stats.lines;
                document.getElementById('statSentences').textContent = stats.sentences;
                document.getElementById('statParagraphs').textContent = stats.paragraphs;
                document.getElementById('statReadingTime').textContent = stats.readingTime;
                document.getElementById('statSpeakingTime').textContent = stats.speakingTime;

                showModal(wordCountModal);
            }

            function setupAutoSave() {
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                }

                if (settings.autoSave !== 'off') {
                    const interval = parseInt(settings.autoSave) * 60 * 1000;
                    autoSaveInterval = setInterval(() => {
                        if (!currentNote) return; // nothing to save

                        // Keep plaintext notes synced with editor
                        if (!currentNote.isEncrypted) {
                            currentNote.content = editor.value;
                        }

                        currentNote.updatedAt = Date.now();
                        saveCurrentNote();
                        setStatus('Note auto-saved.');
                    }, interval);
                }
            }

            function isLikelyEncrypted(content) {
                if (!content || typeof content !== 'string') return false;

                const trimmed = content.trim();
                
                // Check if it looks like our encrypted format (base64 URL-safe)
                if (/^[A-Za-z0-9\-_]+$/.test(trimmed) && trimmed.length >= 44) { // Minimum length for encrypted data
                    return true;
                }

                // Check if it's a JSON export from older versions
                try {
                    if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                        const parsed = JSON.parse(trimmed);
                        return parsed && parsed.note && parsed.note.isEncrypted;
                    }
                } catch {
                    // Not JSON, continue checking
                }

                // Check for common encrypted data patterns
                if (trimmed.includes('"encrypted":true') || 
                    trimmed.includes('"isEncrypted":true') ||
                    trimmed.includes('"iv":') && trimmed.includes('"salt":')) {
                    return true;
                }

                return false;
            }

            function updateEditorState() {
                const encrypted = currentNote.isEncrypted;
                
                // Check if content looks encrypted (for pasted content)
                const contentLooksEncrypted = isLikelyEncrypted(currentNote.content);
                
                if (encrypted) {
                    editor.style.display = 'none';
                    encryptedContent.style.display = 'block';
                    encryptedContent.textContent = currentNote.content;
                    editor.readOnly = true;
                    encryptionStatus.textContent = '🔒';
                    encryptionStatus.style.color = 'var(--accent)';
                    btnDecryptNote.disabled = false;
                    btnQuickDecrypt.disabled = false;
                } else {
                    editor.style.display = 'block';
                    encryptedContent.style.display = 'none';
                    editor.value = currentNote.content;
                    editor.readOnly = false;
                    encryptionStatus.textContent = '🔓';
                    encryptionStatus.style.color = 'var(--muted)';
                    
                    // Enable decrypt button if content looks encrypted (for pasted content)
                    btnDecryptNote.disabled = !contentLooksEncrypted;
                    btnQuickDecrypt.disabled = !contentLooksEncrypted;
                }

                btnEncryptNote.disabled = encrypted;
                btnQuickEncrypt.disabled = encrypted;

                noteTitle.textContent = currentNote.title;

                // Update note list highlighting
                document.querySelectorAll('.note-item').forEach(item => {
                    const noteId = item.getAttribute('data-id');
                    item.classList.toggle('active', noteId === currentNote.id);
                });

                renderNoteList();
                updateCounts();
            }

            function updateParamInfo() {
                const encryptPreset = qs('#encryptArgonPreset').value;
                qs('#encryptParamInfo').textContent = argonParams[encryptPreset].desc;

                const decryptPreset = qs('#decryptArgonPreset').value;
                qs('#decryptParamInfo').textContent = argonParams[decryptPreset].desc;
            }

            function createNewNote() {
                currentNote = {
                    id: generateId(),
                    content: '',
                    isEncrypted: false,
                    encryptionParams: null,
                    fileHandle: null,
                    title: 'Untitled Note',
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    passwordHint: ''
                };

                notes.unshift(currentNote);
                saveNotes();
                renderNoteList();

                updateEditorState();
                updateCounts();
                editor.focus();
                setStatus('New note created.');
            }

            function saveCurrentNote() {
                currentNote.updatedAt = Date.now();

                const noteCopy = { ...currentNote }; // clone snapshot

                const index = notes.findIndex(note => note.id === currentNote.id);
                if (index !== -1) {
                    notes[index] = noteCopy;
                } else {
                    notes.unshift(noteCopy);
                }

                saveNotes();
            }

            function loadNoteById(noteId) {
                const note = notes.find(n => n.id === noteId);
                if (note) {
                    currentNote = { ...note };
                    updateEditorState();
                    updateCounts();
                    setStatus(`Loaded note: ${currentNote.title}`);
                }
            }

            function clearNote() {
                if (currentNote.isEncrypted) {
                    if (!confirm('This will clear the encrypted content. Continue?')) {
                        return;
                    }
                }
                currentNote.content = '';
                updateEditorState();
                updateCounts();
                editor.focus();
                setStatus('Note cleared.');
            }

            function copyToClipboard() {
                try {
                    const textToCopy = currentNote.isEncrypted ? currentNote.content : editor.value;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        setStatus('Copied to clipboard!');

                        // Setup clipboard clearing if enabled
                        if (settings.clearClipboard !== '0') {
                            setTimeout(() => {
                                navigator.clipboard.writeText('').then(() => {
                                    console.log('Clipboard cleared');
                                });
                            }, parseInt(settings.clearClipboard) * 1000);
                        }
                    }).catch(err => {
                        setStatus('Failed to copy: ' + err);
                    });
                } catch (err) {
                    setStatus('Failed to copy: ' + err);
                }
            }

            async function saveNoteToFile() {
                // Update content from editor if not encrypted
                if (!currentNote.isEncrypted) {
                    currentNote.content = editor.value;
                }

                try {
                    let fileHandle;

                    // If we already have a file handle, use it
                    if (currentNote.fileHandle) {
                        fileHandle = currentNote.fileHandle;
                    } else {
                        // Otherwise, show the file picker
                        try {
                            // Always use .txt extension regardless of encryption status
                            fileHandle = await window.showSaveFilePicker({
                                suggestedName: getSuggestedFilename(),
                                types: [{
                                    description: 'Text Files',
                                    accept: {
                                        'text/plain': ['.txt']
                                    }
                                }]
                            });
                        } catch (err) {
                            // User cancelled the save dialog or API not available
                            if (err.name !== 'AbortError') {
                                console.error('Error saving file:', err);
                            }
                            // Always fall back to download method on error
                            fallbackSave();
                            return;
                        }
                    }

                    // Create a writer
                    const writable = await fileHandle.createWritable();

                    // Write the content
                    await writable.write(currentNote.content);
                    await writable.close();

                    // Remember the file handle for future saves
                    currentNote.fileHandle = fileHandle;
                    currentNote.title = fileHandle.name;

                    updateEditorState();
                    setStatus('Note saved to ' + fileHandle.name);

                    // Also save to local storage
                    saveCurrentNote();
                } catch (err) {
                    console.error('Error saving file:', err);
                    // Fallback to download if File System Access API is not available
                    fallbackSave();
                }
            }

            async function exportNote() {
                // Update content from editor if not encrypted
                if (!currentNote.isEncrypted) {
                    currentNote.content = editor.value;
                }

                // Create export data
                const exportData = {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    note: currentNote
                };

                // Create a blob with the content
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);

                // Create a download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `${getSuggestedFilename()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                setStatus('Note exported as ' + a.download);
            }

            function fallbackSave() {
                // Create a blob with the content
                const blob = new Blob([currentNote.content], {
                    type: 'text/plain'
                });
                const url = URL.createObjectURL(blob);

                // Create a download link
                const a = document.createElement('a');
                a.href = url;
                // Always use .txt extension regardless of encryption status
                a.download = getSuggestedFilename();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                setStatus('Note downloaded as ' + a.download);
            }

            function getSuggestedFilename() {
                if (currentNote.fileHandle) {
                    return currentNote.fileHandle.name;
                }

                // Use the note title first
                let baseName = (currentNote.title || 'secure_note')
                    .replace(/[^a-z0-9]/gi, '_') // safe filename
                    .toLowerCase()
                    .substring(0, 30); // limit length

                if (!baseName) baseName = 'secure_note';

                return `${baseName}.txt`;
            }

            function b64UrlEncode(buf) {
                const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
                return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }

            function b64UrlDecode(str) {
                let s = str.replace(/-/g, '+').replace(/_/g, '/');
                const pad = (4 - (s.length % 4)) % 4;
                s += '='.repeat(pad);
                return Uint8Array.from(atob(s), c => c.charCodeAt(0));
            }

            async function deriveKey(pass, salt, params) {
                const p = argonParams[params.preset || 'moderate'];

                // Use only Argon2id (removed PBKDF2 fallback)
                if (window.argon2 && typeof argon2.hash === 'function') {
                    const {
                        hash
                    } = await argon2.hash({
                        pass,
                        salt,
                        time: p.time,
                        mem: p.mem,
                        hashLen: 32,
                        parallelism: p.parallelism,
                        type: argon2.ArgonType.Argon2id
                    });
                    return crypto.subtle.importKey('raw', hash, {
                        name: 'AES-GCM'
                    }, false, ['encrypt', 'decrypt']);
                } else {
                    throw new Error('Argon2 is not available');
                }
            }

            async function encryptNoteContent(content, password, params) {
                if (!content) content = '';
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));

                setStatus('Deriving encryption key (this may take a moment)...', true);
                const key = await deriveKey(password, salt, params);

                const data = new TextEncoder().encode(content);
                const ct = new Uint8Array(await crypto.subtle.encrypt({
                    name: 'AES-GCM',
                    iv
                }, key, data));

                const blob = new Uint8Array(salt.length + iv.length + ct.length);
                blob.set(salt, 0);
                blob.set(iv, salt.length);
                blob.set(ct, salt.length + iv.length);

                return {
                    encrypted: b64UrlEncode(blob),
                    params: {
                        ...params,
                        preset: params.preset || 'moderate',
                        salt: b64UrlEncode(salt),
                        iv: b64UrlEncode(iv)
                    }
                };
            }

            async function decryptNoteContent(encryptedContent, password, params) {
                if (!encryptedContent) return '';

                let bytes;
                try {
                    bytes = b64UrlDecode(encryptedContent);
                } catch {
                    throw new Error('Invalid format: not a valid base64 string.');
                }

                if (bytes.length <= 28) throw new Error('Data too short or corrupted.');

                const salt = bytes.slice(0, 16);
                const iv = bytes.slice(16, 28);
                const ct = bytes.slice(28);

                setStatus('Deriving decryption key (this may take a moment)...', true);
                const key = await deriveKey(password, salt, params || {
                    preset: 'moderate'
                });

                let pt;
                try {
                    pt = await crypto.subtle.decrypt({
                        name: 'AES-GCM',
                        iv
                    }, key, ct);
                } catch {
                    throw new Error('Decryption failed. Wrong password or corrupted data.');
                }

                return new TextDecoder().decode(pt);
            }

            // Unified modal management functions
            function hideModal(modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    if (!modal.classList.contains('active')) {
                        modal.style.display = 'none';
                    }
                }, 300); // match your CSS transition
            }

            function showModal(modal) {
                modal.style.display = 'flex';
                requestAnimationFrame(() => modal.classList.add('active'));
            }

            function showEncryptModal() {
                qs('#encryptPassword').value = '';
                qs('#encryptHint').value = currentNote.passwordHint || '';
                qs('#encryptArgonPreset').value = settings.defaultEncryption;
                updateParamInfo();
                showModal(encryptModal);
                qs('#encryptPassword').focus();
            }

            function hideEncryptModal() {
                hideModal(encryptModal);
            }

            async function doEncrypt() {
                try {
                    const password = qs('#encryptPassword').value;
                    if (!password) {
                        alert('Password required');
                        return;
                    }

                    const preset = qs('#encryptArgonPreset').value;
                    const content = editor.value;
                    const passwordHint = qs('#encryptHint').value;
                    const params = { preset, timestamp: Date.now() };

                    hideEncryptModal();
                    setStatus('Encrypting note...', true);

                    const { encrypted, params: encryptionParams } =
                        await encryptNoteContent(content, password, params);

                    currentNote = {
                        ...currentNote,
                        content: encrypted,   // 🔒 ciphertext
                        isEncrypted: true,
                        encryptionParams,
                        passwordHint,
                        title: currentNote.title.endsWith(' (Encrypted)')
                            ? currentNote.title
                            : currentNote.title + ' (Encrypted)'
                    };

                    // 🔥 force save ciphertext to localStorage
                    saveCurrentNote();

                    updateEditorState();
                    setStatus('Note encrypted successfully.');
                } catch (e) {
                    setStatus('Encryption failed: ' + e.message);
                    console.error(e);
                }
            }

            function showDecryptModal() {
                qs('#decryptPassword').value = '';
                qs('#decryptArgonPreset').value = 'moderate';
                updateParamInfo();

                const passwordHintEl = qs('#passwordHint');
                if (currentNote.passwordHint) {
                    passwordHintEl.textContent = `Hint: ${currentNote.passwordHint}`;
                    passwordHintEl.style.display = 'block';
                } else {
                    passwordHintEl.style.display = 'none';
                }

                showModal(decryptModal);
                qs('#decryptPassword').focus();
            }

            function hideDecryptModal() {
                hideModal(decryptModal);
            }

            async function doDecrypt() {
                try {
                    const password = qs('#decryptPassword').value;
                    if (!password) {
                        alert('Password required');
                        return;
                    }

                    // Capture the preset BEFORE hiding the modal
                    const preset = qs('#decryptArgonPreset').value;
                    const params = { preset };

                    // Now hide the modal
                    hideDecryptModal();

                    setStatus('Decrypting note...', true);

                    const decryptedContent = await decryptNoteContent(currentNote.content, password, params);

                    currentNote = {
                        ...currentNote,
                        content: decryptedContent,   // 🔓 plaintext
                        isEncrypted: false,
                        encryptionParams: null,
                        title: currentNote.title.replace(' (Encrypted)', '')
                    };

                    // 🔥 Save immediately so localStorage has plaintext
                    saveCurrentNote();

                    // Update everything after saving
                    updateEditorState();
                    renderNoteList();   // refresh sidebar so lock icon disappears
                    updateCounts();     // recalc word/char/line counts
                    setStatus('Note decrypted successfully.');

                    // Clear password AFTER successful decryption
                    qs('#decryptPassword').value = '';

                } catch (e) {
                    setStatus('Decryption failed: ' + e.message);
                    console.error(e);
                    // Don't clear password on error so user can try again
                }
            }

            async function loadNoteFromFile() {
                try {
                    // Show file picker
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'Text Files',
                            accept: {
                                'text/plain': ['.txt'],
                                'application/json': ['.json']
                            }
                        }]
                    });

                    // Get the file
                    const file = await fileHandle.getFile();
                    const content = await file.text();

                    // Check if it's an exported JSON file
                    if (file.name.endsWith('.json')) {
                        try {
                            const exportData = JSON.parse(content);
                            if (exportData.note) {
                                // Import the note
                                currentNote = {
                                    ...exportData.note,
                                    id: generateId(),
                                    fileHandle: null
                                };
                                notes.unshift(currentNote);
                                saveNotes();
                                updateEditorState();
                                setStatus(`Imported note: ${currentNote.title}`);
                                return;
                            }
                        } catch {
                            // Not a valid export file, continue as plain text
                        }
                    }

                    // Handle plain text file
                    const isEncrypted = isLikelyEncrypted(content);

                    currentNote = {
                        id: generateId(),
                        content,
                        isEncrypted,
                        encryptionParams: null,
                        fileHandle,
                        title: file.name,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        passwordHint: ''
                    };

                    notes.unshift(currentNote);
                    saveNotes();
                    updateEditorState();
                    setStatus(`Loaded file: ${file.name}`);

                } catch (err) {
                    // User cancelled the open dialog or API not available
                    if (err.name !== 'AbortError') {
                        console.error('Error loading file:', err);
                        setStatus('Error loading file: ' + err.message);
                    }
                }
            }

            function showSettingsModal() {
                // Populate settings form
                qs('#autoSave').value = settings.autoSave;
                qs('#spellCheck').value = settings.spellCheck;
                qs('#defaultEncryption').value = settings.defaultEncryption;
                qs('#clearClipboard').value = settings.clearClipboard;
                qs('#sessionTimeout').value = settings.sessionTimeout;
                qs('#theme').value = settings.theme;
                qs('#fontSize').value = settings.fontSize;
                qs('#fontFamily').value = settings.fontFamily;

                showModal(settingsModal);
            }

            function hideSettingsModal() {
                hideModal(settingsModal);
            }

            function saveSettingsFromModal() {
                settings.autoSave = qs('#autoSave').value;
                settings.spellCheck = qs('#spellCheck').value;
                settings.defaultEncryption = qs('#defaultEncryption').value;
                settings.clearClipboard = qs('#clearClipboard').value;
                settings.sessionTimeout = qs('#sessionTimeout').value;
                settings.theme = qs('#theme').value;
                settings.fontSize = qs('#fontSize').value;
                settings.fontFamily = qs('#fontFamily').value;

                if (saveSettings()) {
                    applySettings();
                    setupAutoSave();
                    hideSettingsModal();
                    setStatus('Settings saved.');
                }
            }

            function showPasswordGenerator() {
                showModal(passwordGeneratorModal);
                generateNewPassword();
            }

            function hidePasswordGenerator() {
                hideModal(passwordGeneratorModal);
            }

            function generateNewPassword() {
                const length = parseInt(qs('#passwordLength').value);
                const includeUppercase = qs('#includeUppercase').checked;
                const includeLowercase = qs('#includeLowercase').checked;
                const includeNumbers = qs('#includeNumbers').checked;
                const includeSymbols = qs('#includeSymbols').checked;

                const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const lowercase = 'abcdefghijklmnopqrstuvwxyz';
                const numbers = '0123456789';
                const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';

                let charset = '';
                if (includeUppercase) charset += uppercase;
                if (includeLowercase) charset += lowercase;
                if (includeNumbers) charset += numbers;
                if (includeSymbols) charset += symbols;

                // Ensure at least one character type is selected
                if (!charset) {
                    charset = lowercase + uppercase + numbers;
                }

                let password = '';
                const values = new Uint32Array(length);
                crypto.getRandomValues(values);

                for (let i = 0; i < length; i++) {
                    password += charset[values[i] % charset.length];
                }

                generatedPasswordInput.value = password;
                updatePasswordStrength(password);
            }

            function updatePasswordStrength(password) {
                let strength = 0;
                let feedback = '';

                // Length check
                if (password.length >= 12) strength += 2;
                else if (password.length >= 8) strength += 1;

                // Character variety checks
                if (/[A-Z]/.test(password)) strength += 1;
                if (/[a-z]/.test(password)) strength += 1;
                if (/[0-9]/.test(password)) strength += 1;
                if (/[^A-Za-z0-9]/.test(password)) strength += 2;

                // Determine strength level
                let strengthLevel;
                if (strength >= 7) {
                    strengthLevel = 'strong';
                    feedback = 'Strong password';
                } else if (strength >= 4) {
                    strengthLevel = 'medium';
                    feedback = 'Medium password';
                } else {
                    strengthLevel = 'weak';
                    feedback = 'Weak password';
                }

                // Update UI
                const strengthValue = qs('#strengthValue');
                const strengthMeter = qs('#strengthMeter');
                
                strengthValue.textContent = feedback;
                strengthValue.className = strengthLevel;
                
                // Update meter width and color
                let meterWidth = 0;
                let meterColor = '#f43f5e'; // red for weak
                
                if (strengthLevel === 'medium') {
                    meterWidth = 50;
                    meterColor = '#f59e0b'; // orange for medium
                } else if (strengthLevel === 'strong') {
                    meterWidth = 100;
                    meterColor = '#22c55e'; // green for strong
                }
                
                strengthMeter.style.width = `${meterWidth}%`;
                strengthMeter.style.background = meterColor;
            }

            function copyGeneratedPassword() {
                navigator.clipboard.writeText(generatedPasswordInput.value).then(() => {
                    setStatus('Password copied to clipboard!');
                    hidePasswordGenerator();
                }).catch(err => {
                    setStatus('Failed to copy password: ' + err);
                });
            }

            function applyTextFormatting(command, value = null) {
                document.execCommand(command, false, value);
                editor.focus();
            }

            function printNote() {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>${currentNote.title}</title>
                            <style>
                                body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                                .note-title { font-size: 24px; margin-bottom: 20px; }
                                .note-content { white-space: pre-wrap; }
                                .encrypted-note { color: #999; font-style: italic; }
                                @media print {
                                    body { margin: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="note-title">${currentNote.title}</div>
                            <div class="note-content">${currentNote.isEncrypted ? 
                                '<div class="encrypted-note">[Encrypted content cannot be displayed]</div>' : 
                                editor.value.replace(/\n/g, '<br>')}</div>
                            <div style="margin-top: 30px; font-size: 12px; color: #666;">
                                Printed from Secure Notepad Pro on ${new Date().toLocaleString()}
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                
                // Wait for content to load before printing
                setTimeout(() => {
                    printWindow.print();
                    // printWindow.close(); // Don't close automatically - let user decide
                }, 250);
            }

            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error('Error attempting to enable fullscreen:', err);
                    });
                    isFullscreen = true;
                    btnFullscreen.innerHTML = '<i class="fas fa-compress"></i>';
                    btnFullscreen.title = 'Exit Fullscreen';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        isFullscreen = false;
                        btnFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
                        btnFullscreen.title = 'Toggle Fullscreen';
                    }
                }
            }

            function showDeleteConfirm(note) {
                noteToDelete = note;
                qs('#deleteNoteName').textContent = note.title;
                showModal(deleteConfirmModal);
            }

            function hideDeleteConfirm() {
                hideModal(deleteConfirmModal);
                noteToDelete = null;
            }

            function deleteNote() {
                if (!noteToDelete) return;

                notes = notes.filter(n => n.id !== noteToDelete.id);

                // If we deleted the current note, create a fresh empty one
                if (currentNote.id === noteToDelete.id) {
                    createNewNote();
                }

                saveNotes();
                renderNoteList();
                hideDeleteConfirm();
                setStatus(`Note "${noteToDelete.title}" deleted.`);
                noteToDelete = null;
            }

        })();
    </script>
</body>

</html>
