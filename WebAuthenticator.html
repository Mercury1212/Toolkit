<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Authenticator â€” Argon2id encrypted</title>

<!-- Use a bundled Argon2 so wasm loads reliably -->
<script src="argon2-bundled.min.js"></script>

<!-- QR Code library -->
<script src="qrcode.min.js"></script>

<!-- Google API Client Library -->
<script src="https://apis.google.com/js/api.js"></script>

<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#2dd4bf;
    --danger:#ff6b6b; --success:#4ade80;
    --glass: rgba(255,255,255,0.03);
    --transition: all 0.2s ease;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(180deg,#021027 0%, #07132a 100%);
    color:#e6eef6; display:flex; align-items:center; justify-content:center;
    padding:20px;
    box-sizing: border-box;
  }
  .wrapper{
    width:700px; 
    max-width:96vw;
    box-sizing: border-box;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:18px;
    padding: 0 12px;
    box-sizing: border-box;
  }
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px}
  
  /* Enhanced button styles */
  button{
    background:var(--glass);
    border:1px solid rgba(255,255,255,0.06);
    color:inherit;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    outline: none;
    white-space: nowrap;
  }
  button::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.3);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }
  button:focus:not(:active)::after {
    animation: ripple 0.6s ease-out;
  }
  @keyframes ripple {
   0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    20% {
      transform: scale(10, 10);
      opacity: 0.3;
    }
    100% {
      transform: scale(35, 35);
      opacity: 0;
    }
  }
  button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border-color: rgba(255,255,255,0.1);
  }
  button:active {
    transform: translateY(1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  button.primary{
    background:linear-gradient(90deg,#06313a,#044b56);
    box-shadow:0 4px 12px rgba(2,6,23,0.6);
    border:none;
  }
  button.primary:hover {
    background:linear-gradient(90deg,#07444f,#06606d);
    box-shadow:0 6px 16px rgba(2,6,23,0.7);
  }
  button.danger{
    background:linear-gradient(90deg,#441111,#661111);
    border:none;
  }
  button.danger:hover {
    background:linear-gradient(90deg,#551111,#771111);
  }
  button.success {
    background:linear-gradient(90deg,#114422,#116633);
    border:none;
  }
  button.success:hover {
    background:linear-gradient(90deg,#225533,#227744);
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
  }
  
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); 
    padding:20px;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(2,6,23,0.6); 
    border:1px solid rgba(255,255,255,0.03);
    transition: var(--transition);
    box-sizing: border-box;
    height: 100%;
    overflow: hidden;
  }
  .card:hover {
    box-shadow:0 8px 24px rgba(2,6,23,0.7);
    border-color: rgba(255,255,255,0.05);
  }
  
  .entry{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px;
    border-radius:10px;
    margin-bottom:8px;
    background:rgba(255,255,255,0.01);
    border:1px solid rgba(255,255,255,0.02);
    transition: var(--transition);
    cursor: pointer;
    box-sizing: border-box;
  }
  .entry:hover {
    background:rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.05);
    transform: translateX(2px);
  }
  .entry.selected {
    background:rgba(45, 212, 191, 0.08);
    border-color: rgba(45, 212, 191, 0.2);
  }
  .entry .meta{display:flex;gap:12px;align-items:center}
  .badge{
    background:rgba(255,255,255,0.03);
    padding:6px 10px;
    border-radius:8px;
    font-weight:600;
    transition: var(--transition);
    box-sizing: border-box;
  }
  .badge.success {
    background: rgba(74, 222, 128, 0.15);
    color: #4ade80;
  }
  .badge.warning {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
  }
  .badge.danger {
    background: rgba(255, 107, 107, 0.15);
    color: #ff6b6b;
  }
  .totp{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; 
    font-size:20px; 
    letter-spacing:2px;
    font-weight: bold;
    color: var(--accent);
    min-width: 90px;
    text-align: center;
  }
  .small{font-size:12px;color:var(--muted)}
  .center{display:flex;align-items:center;justify-content:center}
  footer{
    margin-top: 16px;
    padding-top: 16px;
    color:var(--muted);
    font-size:13px;
    box-sizing: border-box;
    border-top: 1px solid rgba(255,255,255,0.03);
  }

  /* Search bar */
  .search-container {
    display: flex;
    margin-bottom: 16px;
    gap: 8px;
  }
  .search-input {
    flex: 1;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(0,0,0,0.2);
    color: inherit;
    transition: var(--transition);
    font-family: inherit;
    box-sizing: border-box;
  }
  .search-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
  }
  .search-btn {
    padding: 10px 16px;
  }
  
  /* Password input with peek button */
  .password-container {
    position: relative;
  }
  .password-input {
    width: 100%;
    padding: 10px 40px 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(0,0,0,0.2);
    color: inherit;
    transition: var(--transition);
    font-family: inherit;
    box-sizing: border-box;
  }
  .password-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
  }
  .peek-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
  }
  .peek-btn:hover {
    background: rgba(255,255,255,0.05);
    color: var(--accent);
  }
  /* Prevent eye icon from moving like normal buttons */
.peek-btn:hover,
.peek-btn:active {
    transform: translateY(-50%) !important;
    box-shadow: none !important;
}

  /* modal */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(2,6,23,0.8);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:40;
    backdrop-filter: blur(4px);
    padding: 20px;
    box-sizing: border-box;
  }
  .modal{
    background:linear-gradient(180deg, #061226, #041521);
    padding:24px;
    border-radius:16px;
    max-width:520px;
    width:100%;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow: 0 20px 40px rgba(2,6,23,0.8);
    animation: modalFadeIn 0.2s ease-out;
    box-sizing: border-box;
  }
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .modal h2{margin:0 0 16px 0; font-size: 1.5rem;}
  label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin:12px 0 6px;
  }
  input[type=text], input[type=password], textarea, select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(0,0,0,0.2);
    color:inherit;
    transition: var(--transition);
    font-family: inherit;
    box-sizing: border-box;
  }
  input[type=text]:focus, input[type=password]:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
  }
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
  .help{
    font-size:12px;
    color:var(--muted);
    margin-top:12px; 
    line-height: 1.4;
    box-sizing: border-box;
  }

  .meter{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden; margin-top: 8px;}
  .meter > i{display:block;height:100%; background: var(--accent); border-radius: 8px;}

  .tiny{font-size:11px;color:var(--muted)}
  .muted{color:var(--muted)}
  
  /* Progress bar animation for countdown */
  @keyframes countdownProgress {
    from { width: 100%; }
    to { width: 0%; }
  }
  .countdown-progress {
    height: 3px;
    background: var(--accent);
    border-radius: 3px;
    margin-top: 4px;
    animation: countdownProgress 30s linear infinite;
  }
  
  /* List container with fixed height and scrolling */
  .list-container {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 12px;
    padding-right: 4px;
  }
  
  /* Custom scrollbar */
  .list-container::-webkit-scrollbar {
    width: 6px;
  }
  .list-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 3px;
  }
  .list-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }
  .list-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  /* Status bar */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }
  
  /* No results message */
  .no-results {
    text-align: center;
    padding: 30px;
    color: var(--muted);
    font-style: italic;
  }
  
  /* Collapsing bar countdown */
  .countdown-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  
  .countdown-bar {
    flex: 1;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }
  
  .countdown-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 1s linear;
  }
  
  .countdown-text {
    font-size: 12px;
    color: var(--muted);
    min-width: 40px;
    text-align: right;
  }
  
  /* CSV Import/Export styles */
  .csv-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.03);
  }
  
  .csv-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  /* Google Drive button style */
  .google-drive-btn {
    background: linear-gradient(90deg, #4285f4, #34a853);
    border: none;
  }
  .google-drive-btn:hover {
    background: linear-gradient(90deg, #5394f5, #45b363);
  }
  
  /* Google Drive file browser */
  .drive-file-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 15px 0;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    background: rgba(0,0,0,0.1);
  }
  
  .drive-file-item {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    transition: var(--transition);
  }
  
  .drive-file-item:hover {
    background: rgba(255,255,255,0.05);
  }
  
  .drive-file-item:last-child {
    border-bottom: none;
  }
  
  .drive-file-name {
    font-weight: 500;
  }
  
  .drive-file-modified {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  @media (max-width: 600px) {
    body {
      padding: 12px;
      align-items: flex-start;
      padding-top: 20px;
    }
    .wrapper {
      max-width: 100%;
    }
    .controls {
      flex-direction: column;
      width: 100%;
    }
    .controls button {
      width: 100%;
    }
    .entry {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .entry-actions {
      width: 100%;
      display: flex;
      justify-content: space-between;
    }
    .search-container {
      flex-direction: column;
    }
    .csv-buttons {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="wrapper">
  <header>
    <h1>Web Authenticator â€” Argon2id encrypted</h1>
    <div class="controls">
      <button id="btnCreate" class="primary">Create new DB</button>
      <button id="btnLoad">Load DB</button>
      <button id="btnLoadGoogle" class="google-drive-btn">Load from Google Drive</button>
      <button id="btnSave" disabled>Save DB</button>
      <button id="btnLock" disabled>Lock</button>
    </div>
  </header>

  <div class="card">
    <div class="status-bar">
      <div>
        <div class="small">Database Status</div>
        <div id="status" class="badge">Locked â€” no database open</div>
      </div>
      <div>
        <button id="btnAdd" disabled>Add entry</button>
      </div>
    </div>

    <!-- Search bar -->
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Search entries..." disabled>
      <button id="searchBtn" class="search-btn" disabled>Search</button>
      <button id="clearSearchBtn" class="danger" style="display: none;">Clear</button>
    </div>

    <div class="list-container" id="entries"></div>
    
    <!-- CSV Import/Export Section -->
    <div class="csv-section">
      <div class="small">CSV Import/Export</div>
      <div class="csv-buttons">
        <button id="btnExportCSV" disabled>Export to CSV</button>
        <button id="btnImportCSV" disabled>Import from CSV</button>
      </div>
    </div>
    
    <footer>
      <div>Storage: local file only. Argon2id parameters are stored inside the encrypted file for correct re-derivation.</div>
      <div class="countdown-container">
        <div class="countdown-bar">
          <div class="countdown-fill" id="countdownBar"></div>
        </div>
        <div class="countdown-text">Refresh in: <span id="countdown">--</span>s</div>
      </div>
    </footer>
  </div>
</div>

<!-- Modals -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" id="modal">
    <!-- dynamic content -->
  </div>
</div>

<input type="file" id="fileInput" accept=".auth" style="display:none" />
<input type="file" id="csvFileInput" accept=".csv" style="display:none" />

<script>
/*
  Full Web Authenticator
  - Argon2id via argon2-browser bundled
  - AES-GCM encryption for DB
  - TOTP using WebCrypto HMAC-SHA1
  - Save/Load via file download/upload
  - CSV Import/Export functionality
  - Google Drive integration
*/

/* ---------- Utilities ---------- */
const u8ToB64 = u8 => btoa(String.fromCharCode(...u8));
const b64ToU8 = b64 => Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
const strToU8 = s => new TextEncoder().encode(s);
const u8ToStr = u8 => new TextDecoder().decode(u8);

function randBytes(n){ return crypto.getRandomValues(new Uint8Array(n)); }
function nowUnix(){ return Math.floor(Date.now() / 1000); }

/* Base32 decode (RFC4648, no padding required) */
function base32Decode(s){
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  s = s.replace(/=+$/,'').replace(/\s+/g,'').toUpperCase();
  let bits = 0, value = 0;
  const bytes = [];
  for(let i=0;i<s.length;i++){
    const idx = alphabet.indexOf(s[i]);
    if(idx === -1) continue;
    value = (value << 5) | idx;
    bits += 5;
    if(bits >= 8){
      bits -= 8;
      bytes.push((value >> bits) & 0xFF);
    }
  }
  return new Uint8Array(bytes);
}

/* TOTP: HMAC-SHA1 counter -> code */
async function hotp(secretBytes, counter, digits=6){
  const counterBytes = new Uint8Array(8);
  let c = BigInt(counter);
  for(let i=7;i>=0;i--){ counterBytes[i] = Number(c & 0xFFn); c >>= 8n; }
  const key = await crypto.subtle.importKey('raw', secretBytes, {name:'HMAC', hash:'SHA-1'}, false, ['sign']);
  const sig = new Uint8Array(await crypto.subtle.sign('HMAC', key, counterBytes));
  const offset = sig[sig.length - 1] & 0x0f;
  const bin = ((sig[offset] & 0x7f) << 24) | (sig[offset+1] << 16) | (sig[offset+2] << 8) | (sig[offset+3]);
  const code = (bin % (10 ** digits)).toString().padStart(digits, '0');
  return code;
}

async function totpForSecret(base32Secret, period=30, digits=6){
  const secretBytes = base32Decode(base32Secret);
  const t = Math.floor(Date.now() / 1000 / period);
  return hotp(secretBytes, BigInt(t), digits);
}

/* ---------- QR Code Generation ---------- */
function generateQRCode(url, width = 200, height = 200) {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    QRCode.toCanvas(canvas, url, { 
      width: width,
      height: height,
      margin: 1,
      color: {
        dark: '#000000',
        light: '#ffffff'
      }
    }, function(error) {
      if (error) {
        reject(error);
      } else {
        resolve(canvas.toDataURL('image/png'));
      }
    });
  });
}

function showQRCode(entry) {
  const otpauthUrl = `otpauth://totp/${encodeURIComponent(entry.issuer || entry.label)}:${encodeURIComponent(entry.label)}?secret=${entry.secret}&issuer=${encodeURIComponent(entry.issuer || entry.label)}&digits=${entry.digits}&period=${entry.period}`;
  
  showModal(`
    <h2>QR Code for ${escapeHtml(entry.issuer || entry.label)}</h2>
    <div class="center" style="margin: 20px 0;">
      <div id="qrCodeContainer" style="width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;">
        <div class="small muted">Generating QR code...</div>
      </div>
    </div>
    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin: 10px 0;">
      <div class="small muted">Secret: ${entry.secret}</div>
      <div class="small muted">OTPAuth URL:</div>
      <div class="small" style="word-break: break-all; margin-top: 5px;">${otpauthUrl}</div>
    </div>
    <div class="actions">
      <button id="qrClose">Close</button>
    </div>
  `);
  
  // Generate the QR code after the modal is shown
  setTimeout(() => {
    generateQRCode(otpauthUrl).then(dataUrl => {
      document.getElementById('qrCodeContainer').innerHTML = `<img src="${dataUrl}" alt="QR Code" style="max-width: 100%; height: auto;" />`;
    }).catch(err => {
      console.error('QR code generation failed:', err);
      document.getElementById('qrCodeContainer').innerHTML = `<div class="small danger">Failed to generate QR code</div>`;
    });
  }, 100);
  
  modalEl.querySelector('#qrClose').onclick = closeModal;
}

/* ---------- Argon2id + AES helpers ---------- */
async function deriveKeyArgon2(password, saltBytes, params){
  // argon2-browser hash expects strings for pass and salt; convert salt bytes to string
  const passStr = password;
  const saltStr = Array.from(saltBytes).map(b=>String.fromCharCode(b)).join('');
  try{
    const argObj = await argon2.hash({
      pass: passStr,
      salt: saltStr,
      time: params.time || 3,
      mem: params.mem || 65536,
      parallelism: params.parallelism || 1,
      hashLen: params.hashLen || 32,
      type: argon2.ArgonType.Argon2id
    });
    // argObj.hash is Uint8Array
    return crypto.subtle.importKey('raw', argObj.hash, 'AES-GCM', false, ['encrypt','decrypt']);
  } catch(err){
    console.error('Argon2 error', err);
    throw err;
  }
}

async function aesGcmEncrypt(key, plaintextBytes, iv){
  return new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, plaintextBytes));
}
async function aesGcmDecrypt(key, ciphertextBytes, iv){
  return new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ciphertextBytes));
}

/* ---------- App state ---------- */
let db = { entries: [] }; // decrypted db (plain object)
let cryptoKey = null; // CryptoKey derived from Argon2
let currentFileMeta = null; // for saving: object with salt, params, etc
let totpInterval = null;
let selectedId = null;
let searchQuery = ''; // Current search query
let filteredEntries = []; // Filtered entries based on search
let isAutoSaving = false; // Flag to prevent multiple auto-saves

/* ---------- Google Drive API Integration ---------- */
const GOOGLE_CLIENT_ID = '592659175056-fpmfmq0bu21rfs14fguhah92jmofo12l.apps.googleusercontent.com'; // Replace with your Google Client ID
const GOOGLE_API_KEY = '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'; // Replace with your Google API Key
const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';

let googleAccessToken = null;
let googleAuthInstance = null;

// Initialize Google API
function initGoogleAPI() {
  return new Promise((resolve, reject) => {
    gapi.load('client:auth2', () => {
      gapi.client.init({
        apiKey: GOOGLE_API_KEY,
        clientId: GOOGLE_CLIENT_ID,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        scope: GOOGLE_SCOPES
      }).then(() => {
        googleAuthInstance = gapi.auth2.getAuthInstance();
        resolve();
      }).catch(reject);
    });
  });
}

// Check if user is signed in to Google
function isGoogleSignedIn() {
  return googleAuthInstance && googleAuthInstance.isSignedIn.get();
}

// Sign in to Google
async function signInToGoogle() {
  try {
    if (!googleAuthInstance) {
      await initGoogleAPI();
    }
    
    const googleUser = await googleAuthInstance.signIn();
    googleAccessToken = googleUser.getAuthResponse().access_token;
    return true;
  } catch (error) {
    console.error('Google sign-in error:', error);
    return false;
  }
}

// Sign out from Google
function signOutFromGoogle() {
  if (googleAuthInstance) {
    googleAuthInstance.signOut();
    googleAccessToken = null;
  }
}

// Get list of .auth files from Google Drive
async function getGoogleDriveFiles() {
  try {
    const response = await gapi.client.drive.files.list({
      q: "name contains '.auth' and trashed = false",
      fields: 'files(id, name, modifiedTime)',
      orderBy: 'modifiedTime desc'
    });
    
    return response.result.files;
  } catch (error) {
    console.error('Error fetching Google Drive files:', error);
    throw error;
  }
}

// Download a file from Google Drive
async function downloadFromGoogleDrive(fileId) {
  try {
    const response = await gapi.client.drive.files.get({
      fileId: fileId,
      alt: 'media'
    });
    
    return response.body;
  } catch (error) {
    console.error('Error downloading from Google Drive:', error);
    throw error;
  }
}

// Upload a file to Google Drive
async function uploadToGoogleDrive(filename, content) {
  try {
    const fileMetadata = {
      name: filename,
      mimeType: 'text/plain'
    };
    
    const media = {
      mimeType: 'text/plain',
      body: content
    };
    
    const response = await gapi.client.drive.files.create({
      resource: fileMetadata,
      media: media,
      fields: 'id'
    });
    
    return response.result.id;
  } catch (error) {
    console.error('Error uploading to Google Drive:', error);
    throw error;
  }
}

// Show Google Drive file browser
async function showGoogleDriveFiles() {
  try {
    const files = await getGoogleDriveFiles();
    
    if (files.length === 0) {
      showModal(`
        <h2>Google Drive Files</h2>
        <p>No .auth files found in your Google Drive.</p>
        <div class="actions">
          <button id="driveClose">Close</button>
        </div>
      `);
      
      modalEl.querySelector('#driveClose').onclick = closeModal;
      return;
    }
    
    let filesHtml = files.map(file => `
      <div class="drive-file-item" data-file-id="${file.id}">
        <div class="drive-file-name">${escapeHtml(file.name)}</div>
        <div class="drive-file-modified">Modified: ${new Date(file.modifiedTime).toLocaleString()}</div>
      </div>
    `).join('');
    
    showModal(`
      <h2>Select a Database File</h2>
      <p>Choose a file from your Google Drive:</p>
      <div class="drive-file-list">
        ${filesHtml}
      </div>
      <div class="actions">
        <button id="driveSignOut">Sign Out</button>
        <button id="driveClose">Close</button>
      </div>
    `);
    
    // Add click handlers for file items
    modalEl.querySelectorAll('.drive-file-item').forEach(item => {
      item.addEventListener('click', async () => {
        const fileId = item.getAttribute('data-file-id');
        const fileName = item.querySelector('.drive-file-name').textContent;
        
        showModal(`
          <h2>Unlock Database</h2>
          <p>Opening: ${escapeHtml(fileName)}</p>
          <label>Master password</label>
          <div class="password-container">
            <input id="drive_pw" type="password" placeholder="Enter master password" />
          </div>
          <div class="actions">
            <button id="driveCancel">Cancel</button>
            <button id="driveOpen" class="primary">Open</button>
          </div>
        `);
        
        modalEl.querySelector('#driveCancel').onclick = () => showGoogleDriveFiles();
        modalEl.querySelector('#driveOpen').onclick = async () => {
          const pw = modalEl.querySelector('#drive_pw').value;
          if (!pw) { alert('Password required'); return; }
          
          try {
            const fileContent = await downloadFromGoogleDrive(fileId);
            await processFileContent(fileContent, pw);
            closeModal();
          } catch (error) {
            console.error('Error processing Google Drive file:', error);
            alert('Failed to unlock â€” wrong password or corrupted file.');
          }
        };
      });
    });
    
    modalEl.querySelector('#driveSignOut').onclick = () => {
      signOutFromGoogle();
      closeModal();
    };
    
    modalEl.querySelector('#driveClose').onclick = closeModal;
  } catch (error) {
    console.error('Error showing Google Drive files:', error);
    alert('Failed to access Google Drive: ' + error.message);
  }
}

// Process file content (common for both local and Google Drive files)
async function processFileContent(fileContent, password) {
  let parsed;
  
  // Try to parse as Base64 first (new format)
  try {
    const jsonString = decodeURIComponent(escape(atob(fileContent)));
    parsed = JSON.parse(jsonString);
  } catch (e) {
    // If Base64 parsing fails, try parsing as JSON directly (old format)
    try {
      parsed = JSON.parse(fileContent);
    } catch (jsonError) {
      throw new Error('Invalid file format');
    }
  }
  
  if (!parsed.meta || !parsed.iv || !parsed.ciphertext) {
    throw new Error('Invalid DB file');
  }
  
  const salt = b64ToU8(parsed.meta.salt);
  const params = parsed.meta.params;
  const key = await deriveKeyArgon2(password, salt, params);
  const iv = b64ToU8(parsed.iv);
  const ct = b64ToU8(parsed.ciphertext);
  const pt = await aesGcmDecrypt(key, ct, iv);
  const obj = JSON.parse(u8ToStr(pt));
  
  db = obj;
  cryptoKey = key;
  currentFileMeta = parsed.meta;
  setLockedUI(false);
  startTotpLoop();
  alert('Database unlocked.');
}

/* ---------- DOM ---------- */
const btnCreate = document.getElementById('btnCreate');
const btnLoad = document.getElementById('btnLoad');
const btnLoadGoogle = document.getElementById('btnLoadGoogle');
const btnSave = document.getElementById('btnSave');
const btnLock = document.getElementById('btnLock');
const btnAdd = document.getElementById('btnAdd');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnImportCSV = document.getElementById('btnImportCSV');
const fileInput = document.getElementById('fileInput');
const csvFileInput = document.getElementById('csvFileInput');
const statusEl = document.getElementById('status');
const entriesEl = document.getElementById('entries');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalEl = document.getElementById('modal');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn');
const countdownBar = document.getElementById('countdownBar');
const countdownEl = document.getElementById('countdown');

/* ---------- UI Helpers ---------- */
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function setLockedUI(locked){
  btnCreate.disabled = !locked;
  btnLoad.disabled = !locked;
  btnLoadGoogle.disabled = !locked;
  btnSave.disabled = locked;
  btnLock.disabled = locked;
  btnAdd.disabled = locked;
  btnExportCSV.disabled = locked;
  btnImportCSV.disabled = locked;
  searchInput.disabled = locked;
  searchBtn.disabled = locked;
  
  if(locked){
    statusEl.textContent = 'Locked â€” no database open';
    statusEl.className = 'badge';
    entriesEl.innerHTML = '';
  } else {
    statusEl.textContent = 'Unlocked';
    statusEl.className = 'badge success';
    renderEntries();
  }
}

function showModal(html){
  modalEl.innerHTML = html;
  modalBackdrop.style.display = 'flex';
}

function closeModal(){
  modalBackdrop.style.display = 'none';
}

function renderEntries() {
  const entriesToRender = searchQuery ? filteredEntries : db.entries;
  
  if (entriesToRender.length === 0) {
    entriesEl.innerHTML = searchQuery ? 
      `<div class="no-results">No entries found for "${escapeHtml(searchQuery)}"</div>` : 
      `<div class="no-results">No entries yet. Click "Add entry" to get started.</div>`;
    return;
  }
  
  entriesEl.innerHTML = entriesToRender.map(entry => {
    const isSelected = selectedId === entry.id;
    return `
      <div class="entry ${isSelected ? 'selected' : ''}" data-id="${entry.id}">
        <div class="meta">
          <div>
            <div>${escapeHtml(entry.label)}</div>
            <div class="small muted">${escapeHtml(entry.issuer || 'No issuer')}</div>
          </div>
        </div>
        <div class="totp" id="totp-${entry.id}">------</div>
        <div class="entry-actions">
          <button class="small" onclick="copyTOTP('${entry.id}')">Copy</button>
          <button class="small" onclick="editEntry('${entry.id}')">Edit</button>
          <button class="small danger" onclick="deleteEntry('${entry.id}')">Delete</button>
        </div>
      </div>
    `;
  }).join('');
  
  // Add click handler for selecting entries
  entriesEl.querySelectorAll('.entry').forEach(el => {
    el.addEventListener('click', (e) => {
      if (!e.target.closest('button')) {
        const id = el.getAttribute('data-id');
        selectedId = selectedId === id ? null : id;
        renderEntries();
      }
    });
  });
  
  // Update TOTP codes
  updateAllTOTP();
}

async function updateAllTOTP(){
  for(const entry of db.entries){
    const code = await totpForSecret(entry.secret, entry.period || 30, entry.digits || 6);
    const el = document.getElementById(`totp-${entry.id}`);
    if(el) el.textContent = code;
  }
}

function startTotpLoop(){
  if(totpInterval) clearInterval(totpInterval);
  updateAllTOTP();
  totpInterval = setInterval(updateAllTOTP, 1000);
  
  // Start countdown timer
  startCountdown();
}

function startCountdown() {
  let seconds = 30;
  
  function updateCountdown() {
    const progress = (seconds / 30) * 100;
    countdownBar.style.width = `${progress}%`;
    countdownEl.textContent = seconds;
    
    seconds--;
    if (seconds < 0) {
      seconds = 30;
    }
  }
  
  // Update immediately and then every second
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

/* ---------- Entry Management ---------- */
function addEntry(entry){
  entry.id = 'id' + Math.random().toString(16).slice(2);
  db.entries.push(entry);
  renderEntries();
  autoSave();
}

function editEntry(id){
  const entry = db.entries.find(e => e.id === id);
  if(!entry) return;
  
  showModal(`
    <h2>Edit Entry</h2>
    <label>Label (e.g., username)</label>
    <input id="edit_label" type="text" value="${escapeHtml(entry.label)}" />
    <label>Issuer (e.g., Google)</label>
    <input id="edit_issuer" type="text" value="${escapeHtml(entry.issuer || '')}" />
    <label>Secret (Base32)</label>
    <input id="edit_secret" type="text" value="${escapeHtml(entry.secret)}" />
    <div class="help">The secret key in Base32 format (without spaces)</div>
    <div class="row">
      <div>
        <label>Digits</label>
        <select id="edit_digits">
          <option value="6" ${entry.digits === 6 ? 'selected' : ''}>6</option>
          <option value="8" ${entry.digits === 8 ? 'selected' : ''}>8</option>
        </select>
      </div>
      <div>
        <label>Period (seconds)</label>
        <select id="edit_period">
          <option value="30" ${entry.period === 30 ? 'selected' : ''}>30</option>
          <option value="60" ${entry.period === 60 ? 'selected' : ''}>60</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button id="editCancel">Cancel</button>
      <button id="editSave" class="primary">Save</button>
    </div>
  `);
  
  modalEl.querySelector('#editCancel').onclick = closeModal;
  modalEl.querySelector('#editSave').onclick = () => {
    const label = modalEl.querySelector('#edit_label').value.trim();
    const issuer = modalEl.querySelector('#edit_issuer').value.trim();
    const secret = modalEl.querySelector('#edit_secret').value.trim().replace(/\s+/g, '');
    const digits = parseInt(modalEl.querySelector('#edit_digits').value);
    const period = parseInt(modalEl.querySelector('#edit_period').value);
    
    if(!label || !secret) { alert('Label and secret are required'); return; }
    
    entry.label = label;
    entry.issuer = issuer;
    entry.secret = secret;
    entry.digits = digits;
    entry.period = period;
    
    renderEntries();
    autoSave();
    closeModal();
  };
}

function deleteEntry(id){
  if(!confirm('Are you sure you want to delete this entry?')) return;
  db.entries = db.entries.filter(e => e.id !== id);
  if(selectedId === id) selectedId = null;
  renderEntries();
  autoSave();
}

async function copyTOTP(id){
  const entry = db.entries.find(e => e.id === id);
  if(!entry) return;
  const code = await totpForSecret(entry.secret, entry.period || 30, entry.digits || 6);
  try{
    await navigator.clipboard.writeText(code);
    // Visual feedback
    const btn = document.querySelector(`.entry[data-id="${id}"] button`);
    const origText = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = origText; }, 2000);
  } catch(err){
    alert('Failed to copy to clipboard: ' + err);
  }
}

/* ---------- Search Functionality ---------- */
function filterEntries(query) {
  if (!query.trim()) {
    filteredEntries = [...db.entries];
    return;
  }
  
  const lowerQuery = query.toLowerCase();
  filteredEntries = db.entries.filter(entry => 
    entry.label.toLowerCase().includes(lowerQuery) || 
    (entry.issuer && entry.issuer.toLowerCase().includes(lowerQuery))
  );
}

/* ---------- Database Operations ---------- */
async function createNewDB(password){
  if(!password) return;
  
  // Generate new salt and params
  const saltBytes = randBytes(16);
  const params = { time: 3, mem: 65536, parallelism: 1, hashLen: 32 };
  
  try{
    const key = await deriveKeyArgon2(password, saltBytes, params);
    db = { entries: [] };
    cryptoKey = key;
    currentFileMeta = { salt: u8ToB64(saltBytes), params };
    setLockedUI(false);
    startTotpLoop();
    alert('New database created.');
  } catch(err){
    console.error('Failed to create DB', err);
    alert('Failed to create database: ' + err.message);
  }
}

async function saveDB(){
  if(!cryptoKey) return;
  
  const iv = randBytes(12);
  const pt = strToU8(JSON.stringify(db));
  const ct = await aesGcmEncrypt(cryptoKey, pt, iv);
  
  const fileData = {
    meta: currentFileMeta,
    iv: u8ToB64(iv),
    ciphertext: u8ToB64(ct)
  };
  
  // Convert to Base64 for saving
  const jsonString = JSON.stringify(fileData);
  const base64Data = btoa(unescape(encodeURIComponent(jsonString)));
  
  return base64Data;
}

async function autoSave() {
  if (isAutoSaving) return;
  isAutoSaving = true;
  
  try {
    const data = await saveDB();
    localStorage.setItem('lastDatabase', data);
    console.log('Auto-saved to localStorage');
  } catch (error) {
    console.error('Auto-save failed:', error);
  } finally {
    isAutoSaving = false;
  }
}

async function loadFromLocalStorage() {
  const data = localStorage.getItem('lastDatabase');
  if (!data) return false;
  
  try {
    const parsed = JSON.parse(decodeURIComponent(escape(atob(data))));
    if (!parsed.meta || !parsed.iv || !parsed.ciphertext) {
      throw new Error('Invalid stored data');
    }
    return parsed;
  } catch (error) {
    console.error('Failed to load from localStorage:', error);
    localStorage.removeItem('lastDatabase');
    return false;
  }
}

/* ---------- File Operations ---------- */
async function downloadFile(filename, content) {
  const blob = new Blob([content], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
}

/* ---------- CSV Import/Export ---------- */
function exportToCSV() {
  if (db.entries.length === 0) {
    alert('No entries to export');
    return;
  }
  
  const headers = ['Label', 'Issuer', 'Secret', 'Digits', 'Period'];
  const rows = db.entries.map(entry => [
    entry.label,
    entry.issuer || '',
    entry.secret,
    entry.digits || 6,
    entry.period || 30
  ]);
  
  const csvContent = [headers, ...rows]
    .map(row => row.map(field => `"${field.replace(/"/g, '""')}"`).join(','))
    .join('\n');
  
  const filename = `authenticator-export-${new Date().toISOString().slice(0, 10)}.csv`;
  downloadFile(filename, csvContent);
}

function importFromCSV(csvText) {
  try {
    const lines = csvText.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
      throw new Error('CSV file is empty or has no data rows');
    }
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const expectedHeaders = ['Label', 'Issuer', 'Secret', 'Digits', 'Period'];
    
    if (!expectedHeaders.every(h => headers.includes(h))) {
      throw new Error('Invalid CSV format. Expected headers: ' + expectedHeaders.join(', '));
    }
    
    const newEntries = [];
    
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      
      if (values.length !== headers.length) {
        console.warn(`Skipping row ${i + 1}: incorrect number of values`);
        continue;
      }
      
      const entry = {
        label: values[headers.indexOf('Label')],
        issuer: values[headers.indexOf('Issuer')],
        secret: values[headers.indexOf('Secret')].replace(/\s+/g, ''),
        digits: parseInt(values[headers.indexOf('Digits')]) || 6,
        period: parseInt(values[headers.indexOf('Period')]) || 30
      };
      
      if (!entry.label || !entry.secret) {
        console.warn(`Skipping row ${i + 1}: missing label or secret`);
        continue;
      }
      
      newEntries.push(entry);
    }
    
    if (newEntries.length === 0) {
      throw new Error('No valid entries found in CSV file');
    }
    
    // Add new entries to database
    db.entries = [...db.entries, ...newEntries];
    renderEntries();
    autoSave();
    alert(`Successfully imported ${newEntries.length} entries from CSV`);
    
  } catch (error) {
    console.error('CSV import error:', error);
    alert('Failed to import CSV: ' + error.message);
  }
}

/* ---------- Event Listeners ---------- */
btnCreate.onclick = () => {
  showModal(`
    <h2>Create New Database</h2>
    <p>This will create a new encrypted database file.</p>
    <label>Master password</label>
    <div class="password-container">
      <input id="new_pw" type="password" placeholder="Enter a strong master password" />
    </div>
    <label>Confirm password</label>
    <div class="password-container">
      <input id="new_pw2" type="password" placeholder="Confirm your password" />
    </div>
    <div class="actions">
      <button id="createCancel">Cancel</button>
      <button id="createOK" class="primary">Create</button>
    </div>
  `);
  
  modalEl.querySelector('#createCancel').onclick = closeModal;
  modalEl.querySelector('#createOK').onclick = () => {
    const pw = modalEl.querySelector('#new_pw').value;
    const pw2 = modalEl.querySelector('#new_pw2').value;
    if(!pw) { alert('Password required'); return; }
    if(pw !== pw2) { alert('Passwords do not match'); return; }
    createNewDB(pw);
    closeModal();
  };
};

btnLoad.onclick = () => {
  fileInput.click();
};

btnLoadGoogle.onclick = async () => {
  try {
    if (!isGoogleSignedIn()) {
      const signedIn = await signInToGoogle();
      if (!signedIn) {
        alert('Google sign-in failed');
        return;
      }
    }
    
    await showGoogleDriveFiles();
  } catch (error) {
    console.error('Google Drive error:', error);
    alert('Failed to access Google Drive: ' + error.message);
  }
};

btnSave.onclick = async () => {
  try {
    const data = await saveDB();
    const filename = `authenticator-backup-${new Date().toISOString().slice(0, 10)}.auth`;
    downloadFile(filename, data);
    alert('Database saved successfully.');
  } catch (error) {
    console.error('Save failed:', error);
    alert('Failed to save database: ' + error.message);
  }
};

btnLock.onclick = () => {
  if(!confirm('Lock the database? All data will be encrypted and hidden.')) return;
  db = { entries: [] };
  cryptoKey = null;
  currentFileMeta = null;
  if(totpInterval) clearInterval(totpInterval);
  totpInterval = null;
  selectedId = null;
  setLockedUI(true);
  localStorage.removeItem('lastDatabase');
};

btnAdd.onclick = () => {
  showModal(`
    <h2>Add New Entry</h2>
    <label>Label (e.g., username)</label>
    <input id="add_label" type="text" placeholder="Example: john.doe@gmail.com" />
    <label>Issuer (e.g., Google)</label>
    <input id="add_issuer" type="text" placeholder="Example: Google" />
    <label>Secret (Base32)</label>
    <input id="add_secret" type="text" placeholder="Enter the secret key" />
    <div class="help">The secret key in Base32 format (without spaces). You can also scan a QR code.</div>
    <div class="row">
      <div>
        <label>Digits</label>
        <select id="add_digits">
          <option value="6" selected>6</option>
          <option value="8">8</option>
        </select>
      </div>
      <div>
        <label>Period (seconds)</label>
        <select id="add_period">
          <option value="30" selected>30</option>
          <option value="60">60</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button id="addCancel">Cancel</button>
      <button id="addOK" class="primary">Add</button>
    </div>
  `);
  
  modalEl.querySelector('#addCancel').onclick = closeModal;
  modalEl.querySelector('#addOK').onclick = () => {
    const label = modalEl.querySelector('#add_label').value.trim();
    const issuer = modalEl.querySelector('#add_issuer').value.trim();
    const secret = modalEl.querySelector('#add_secret').value.trim().replace(/\s+/g, '');
    const digits = parseInt(modalEl.querySelector('#add_digits').value);
    const period = parseInt(modalEl.querySelector('#add_period').value);
    
    if(!label || !secret) { alert('Label and secret are required'); return; }
    
    addEntry({ label, issuer, secret, digits, period });
    closeModal();
  };
};

btnExportCSV.onclick = exportToCSV;

btnImportCSV.onclick = () => {
  csvFileInput.click();
};

fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  
  showModal(`
    <h2>Unlock Database</h2>
    <p>Opening: ${escapeHtml(file.name)}</p>
    <label>Master password</label>
    <div class="password-container">
      <input id="pw" type="password" placeholder="Enter master password" />
    </div>
    <div class="actions">
      <button id="unlockCancel">Cancel</button>
      <button id="unlockOK" class="primary">Open</button>
    </div>
  `);
  
  modalEl.querySelector('#unlockCancel').onclick = closeModal;
  modalEl.querySelector('#unlockOK').onclick = async () => {
    const pw = modalEl.querySelector('#pw').value;
    if(!pw) { alert('Password required'); return; }
    
    try {
      const fileContent = await file.text();
      await processFileContent(fileContent, pw);
      closeModal();
    } catch (error) {
      console.error('Error processing file:', error);
      alert('Failed to unlock â€” wrong password or corrupted file.');
    }
  };
  
  // Reset file input
  fileInput.value = '';
};

csvFileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (event) => {
    importFromCSV(event.target.result);
  };
  reader.onerror = () => {
    alert('Failed to read CSV file');
  };
  reader.readAsText(file);
  
  // Reset file input
  csvFileInput.value = '';
};

searchInput.addEventListener('input', (e) => {
  searchQuery = e.target.value;
  if (searchQuery) {
    filterEntries(searchQuery);
    renderEntries();
    clearSearchBtn.style.display = 'block';
  } else {
    clearSearchBtn.style.display = 'none';
    renderEntries();
  }
});

searchBtn.onclick = () => {
  filterEntries(searchInput.value);
  renderEntries();
  if (searchInput.value) {
    clearSearchBtn.style.display = 'block';
  }
};

clearSearchBtn.onclick = () => {
  searchInput.value = '';
  searchQuery = '';
  filterEntries('');
  renderEntries();
  clearSearchBtn.style.display = 'none';
};

// Initialize Google API on load
document.addEventListener('DOMContentLoaded', () => {
  // Try to initialize Google API
  if (typeof gapi !== 'undefined') {
    initGoogleAPI().catch(err => {
      console.error('Failed to initialize Google API:', err);
    });
  }
  
  // Try to load from localStorage
  loadFromLocalStorage().then(storedData => {
    if (storedData) {
      showModal(`
        <h2>Found Saved Database</h2>
        <p>Would you like to open the previously saved database?</p>
        <label>Master password</label>
        <div class="password-container">
          <input id="saved_pw" type="password" placeholder="Enter master password" />
        </div>
        <div class="actions">
          <button id="savedCancel">Cancel</button>
          <button id="savedOK" class="primary">Open</button>
        </div>
      `);
      
      modalEl.querySelector('#savedCancel').onclick = closeModal;
      modalEl.querySelector('#savedOK').onclick = async () => {
        const pw = modalEl.querySelector('#saved_pw').value;
        if (!pw) { alert('Password required'); return; }
        
        try {
          const salt = b64ToU8(storedData.meta.salt);
          const params = storedData.meta.params;
          const key = await deriveKeyArgon2(pw, salt, params);
          const iv = b64ToU8(storedData.iv);
          const ct = b64ToU8(storedData.ciphertext);
          const pt = await aesGcmDecrypt(key, ct, iv);
          const obj = JSON.parse(u8ToStr(pt));
          
          db = obj;
          cryptoKey = key;
          currentFileMeta = storedData.meta;
          setLockedUI(false);
          startTotpLoop();
          closeModal();
          alert('Database unlocked from saved session.');
        } catch (error) {
          console.error('Error unlocking saved database:', error);
          alert('Failed to unlock â€” wrong password or corrupted data.');
        }
      };
    }
  });
});

// Close modal when clicking outside
modalBackdrop.onclick = (e) => {
  if(e.target === modalBackdrop) closeModal();
};

// Initialize UI
setLockedUI(true);
</script>
</body>
</html>
